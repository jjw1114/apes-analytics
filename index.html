<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apes Warfare : ë°¸ëŸ°ìŠ¤ ë¶„ì„ ì„¼í„°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        /* ì‹ ë¢°ê° ìˆëŠ” ë”¥ ë¸”ë£¨ & ë„¤ì´ë¹„ í…Œë§ˆ */
        :root { 
            --bg: #0f172a;           /* ì•„ì£¼ ì–´ë‘ìš´ ë„¤ì´ë¹„ (ë°°ê²½) */
            --card-bg: #1e293b;      /* ì§™ì€ ë„¤ì´ë¹„ (ì¹´ë“œ) */
            --text: #f1f5f9;         /* ë°ì€ íšŒìƒ‰ (ë³¸ë¬¸) */
            --accent: #38bdf8;       /* ìŠ¤ì¹´ì´ ë¸”ë£¨ (ê°•ì¡°) */
            --danger: #f87171;       /* ì°¨ë¶„í•œ ë ˆë“œ (ìœ„í—˜) */
            --success: #4ade80;      /* ë¯¼íŠ¸ ê·¸ë¦° (ì„±ê³µ) */
            --warning: #fbbf24;      /* ì•°ë²„ (ê²½ê³ ) */
            --info: #94a3b8;         /* ìŠ¬ë ˆì´íŠ¸ ê·¸ë ˆì´ (ì„¤ëª…) */
            --border: #334155;       /* ê²½ê³„ì„  */
        }

        body { font-family: 'Pretendard', 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 30px; overflow-x: hidden; line-height: 1.6; }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* í—¤ë” */
        h1 { text-align: center; color: var(--text); margin-bottom: 5px; letter-spacing: -0.5px; }
        h1 span { color: var(--accent); }
        .subtitle { text-align: center; color: var(--info); margin-bottom: 40px; font-size: 0.95em; font-weight: 300; }

        /* ê°€ì´ë“œ ì„¹ì…˜ */
        details { background-color: var(--card-bg); border-radius: 12px; padding: 15px 20px; margin-bottom: 30px; border: 1px solid var(--border); }
        summary { cursor: pointer; font-weight: 600; color: var(--accent); font-size: 1.05em; list-style: none; display: flex; align-items: center; justify-content: space-between; }
        summary:hover { color: #7dd3fc; }
        summary::after { content: 'â–¼'; font-size: 0.8em; transition: 0.3s; color: var(--info); }
        details[open] summary::after { transform: rotate(180deg); }
        
        .guide-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 20px; }
        .guide-item { background: #0f172a; padding: 15px; border-radius: 8px; border-top: 3px solid var(--accent); font-size: 0.9em; }
        .guide-item h4 { margin: 0 0 8px 0; color: #fff; font-size: 1em; }
        .formula { background: #1e293b; padding: 4px 8px; border-radius: 4px; font-family: 'Consolas', monospace; color: var(--warning); font-size: 0.85em; display: block; margin: 8px 0; }
        .action-point { color: var(--success); font-weight: 600; margin-top: 10px; display: block; font-size: 0.9em; }

        /* ì—…ë¡œë“œ ë°•ìŠ¤ */
        .upload-box { border: 2px dashed var(--border); border-radius: 16px; padding: 60px; text-align: center; background-color: var(--card-bg); margin-bottom: 30px; cursor: pointer; transition: 0.3s; }
        .upload-box:hover { border-color: var(--accent); background-color: #334155; transform: translateY(-2px); }
        .upload-icon { font-size: 3em; margin-bottom: 15px; display: block; opacity: 0.7; }
        
        /* ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .full-width { grid-column: span 2; }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { background-color: var(--card-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .card h3 { margin: 0 0 20px 0; color: var(--text); font-size: 1.1em; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .card h3::before { content: ''; display: block; width: 4px; height: 16px; background-color: var(--accent); border-radius: 2px; }
        .big-number { font-size: 2.5em; font-weight: 700; color: #fff; margin-bottom: 5px; letter-spacing: -1px; }
        .desc { font-size: 0.9em; color: var(--info); }
        .chart-container { height: 380px; width: 100%; margin-bottom: 15px; }

        /* í…Œì´ë¸” */
        .table-container { overflow-x: auto; max-height: 700px; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 0.95em; white-space: nowrap; }
        th { text-align: left; padding: 16px; background-color: #0f172a; color: var(--accent); position: sticky; top: 0; z-index: 10; font-weight: 600; border-bottom: 2px solid var(--border); }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border); color: #cbd5e1; }
        tr:hover td { background-color: #334155; }
        
        /* íƒœê·¸ */
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 0.75em; font-weight: 700; }
        .tag-danger { background: rgba(248, 113, 113, 0.15); color: #fca5a5; border: 1px solid rgba(248, 113, 113, 0.3); }
        .tag-warn { background: rgba(251, 191, 36, 0.15); color: #fcd34d; border: 1px solid rgba(251, 191, 36, 0.3); }
        .tag-good { background: rgba(74, 222, 128, 0.15); color: #86efac; border: 1px solid rgba(74, 222, 128, 0.3); }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦ Apes Warfare <span>Data Center</span></h1>
        <p class="subtitle">Excel & CSV í˜¸í™˜ ì •ë°€ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</p>
        
        <div class="upload-box" id="dropZone">
            <span class="upload-icon">ğŸ“‚</span>
            <h2 style="margin:0; font-size: 1.5em;">ë°ì´í„° íŒŒì¼ ì—…ë¡œë“œ</h2>
            <p style="margin-top:10px; color: var(--info);">ì§€ì› í˜•ì‹: .csv, .xlsx, .xls (ë“œë˜ê·¸ ì•¤ ë“œë¡­)</p>
            <input type="file" id="fileInput" accept=".csv, .xlsx, .xls" style="display: none;">
        </div>

        <div id="dashboard" class="hidden">
            
            <details>
                <summary>ğŸ“˜ [ë¶„ì„ ê¸°ì¤€] ë°ì´í„° í•´ì„ ê°€ì´ë“œ & ê°œë°œì íŒ</summary>
                <div class="guide-grid">
                    <div class="guide-item">
                        <h4>ğŸ“‰ 1. ì´íƒˆë¥  (Churn Rate)</h4>
                        <span class="formula">í•´ë‹¹ ìŠ¤í…Œì´ì§€ ì´íƒˆì / ì „ì²´ ìœ ì €</span>
                        <p>ìœ ì €ê°€ <b>"ê²Œì„ì„ ì ‘ì€(Last Played)"</b> ìŠ¤í…Œì´ì§€ ë¹„ìœ¨ì…ë‹ˆë‹¤. ìŠ¹íŒ¨ì™€ ê´€ê³„ì—†ì´ ê·¸ íŒì„ ë§ˆì§€ë§‰ìœ¼ë¡œ ê²Œì„ì„ ëˆ ê²½ìš°ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>
                        <span class="action-point">Action: ì´íƒˆ ìƒìœ„ 3ê°œ ë§µì€ ë¬´ì¡°ê±´ ê°œì„ !</span>
                    </div>
                    <div class="guide-item">
                        <h4>ğŸš§ 2. êµ¬ê°„ í†µê³¼ìœ¨ (Pass Rate)</h4>
                        <span class="formula">í´ë¦¬ì–´ ìœ ì € ìˆ˜ / ì‹œë„ ìœ ì € ìˆ˜</span>
                        <p><b>"í—ˆë“¤(Hurdle)"</b>ì„ ì¸¡ì •í•©ë‹ˆë‹¤. ì´ ìˆ˜ì¹˜ê°€ ë‚®ìœ¼ë©´ ë§ì€ ìœ ì €ê°€ ì‹œë„ëŠ” í–ˆìœ¼ë‚˜ ê¹¨ì§€ ëª»í•˜ê³  ìˆë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.</p>
                        <span class="action-point">Action: í†µê³¼ìœ¨ 30% ë¯¸ë§Œì€ 'í†µê³¡ì˜ ë²½'</span>
                    </div>
                    <div class="guide-item">
                        <h4>âš”ï¸ 3. KD ë¹„ìœ¨ (ì¬ë¯¸/íƒ€ê²©ê°)</h4>
                        <span class="formula">ì²˜ì¹˜í•œ ì  / (ë‚´ ìœ ë‹› ì‚¬ë§ + 1)</span>
                        <p><b>1.0 ë¯¸ë§Œ</b>ì´ë©´ 'ë¶ˆì¾Œí•œ ë‚œì´ë„', <b>1.5~2.0</b>ì´ë©´ 'ì«„ê¹ƒí•œ ì¬ë¯¸', <b>3.0 ì´ìƒ</b>ì€ 'í•™ì‚´'ì…ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </details>

            <div class="kpi-grid">
                <div class="card">
                    <h3>ğŸ‘¥ ì´ í”Œë ˆì´ì–´</h3>
                    <div class="big-number" id="totalPlayers">0</div>
                    <div class="desc">ê³ ìœ  ìœ ì €(Unique ID) ê¸°ì¤€</div>
                </div>
                <div class="card">
                    <h3>ğŸ® ì´ í”Œë ˆì´ ì„¸ì…˜</h3>
                    <div class="big-number" id="totalSessions">0</div>
                    <div class="desc">ì „ì²´ ê²Œì„ íŒ ìˆ˜</div>
                </div>
                <div class="card">
                    <h3>ğŸš« ìµœëŒ€ ì´íƒˆ êµ¬ê°„</h3>
                    <div class="big-number" id="topChurnStage" style="color: var(--danger);">?</div>
                    <div class="desc" id="topChurnRate">-</div>
                </div>
                <div class="card">
                    <h3>ğŸ”„ í‰ê·  í´ë¦¬ì–´ ì‹œë„</h3>
                    <div class="big-number" id="avgRetry">0.0íšŒ</div>
                    <div class="desc">í•œ ìŠ¤í…Œì´ì§€ë‹¹ í‰ê·  ë„ì „ íšŸìˆ˜</div>
                </div>
            </div>

            <div class="chart-row">
                <div class="card full-width">
                    <h3>ğŸš¨ [ì´íƒˆ ë¶„ì„] ìœ ì €ë“¤ì€ ì–´ë””ì„œ ê²Œì„ì„ ê»ëŠ”ê°€? (Last Played Stage)</h3>
                    <div id="churnChart" class="chart-container"></div>
                </div>
            </div>

            <div class="chart-row">
                <div class="card">
                    <h3>âš–ï¸ [ë°¸ëŸ°ìŠ¤ ë§µ] ë‚œì´ë„ vs ì¬ë¯¸ (KD ë¹„ìœ¨)</h3>
                    <p style="font-size:0.85em; color:var(--info); margin-bottom:10px;">
                        â€¢ ì› í¬ê¸° = ì´íƒˆ ìœ„í—˜ë„ (í´ìˆ˜ë¡ ìœ„í—˜)<br>
                        â€¢ ìš°ì¸¡ í•˜ë‹¨ = ì‰½ê³  ì¬ë°ŒìŒ / ì¢Œì¸¡ ìƒë‹¨ = ì–´ë µê³  ë¶ˆì¾Œí•¨
                    </p>
                    <div id="scatterChart" class="chart-container"></div>
                </div>
                <div class="card">
                    <h3>â³ [í”Œë ˆì´ íƒ€ì„] ìŠ¹ë¦¬ vs í¬ê¸° ì‹œê°„ ë¹„êµ (ë‹¨ìœ„: ë¶„)</h3>
                    <p style="font-size:0.85em; color:var(--info); margin-bottom:10px;">
                        â€¢ ì§§ì€ í¬ê¸°(ì£¼í™©) = ì´ˆë°˜ ë¶ˆí•©ë¦¬í•¨ (ë°°ì¹˜ ë¬¸ì œ)<br>
                        â€¢ ê¸´ ìŠ¹ë¦¬(ì´ˆë¡) = ì§€ë£¨í•¨, í”¼ë¡œë„ ëˆ„ì 
                    </p>
                    <div id="timeChart" class="chart-container"></div>
                </div>
            </div>

            <div class="card">
                <h3>ğŸ“Š ìŠ¤í…Œì´ì§€ë³„ ìƒì„¸ ì„±ì í‘œ (ê²Œì„ ì§„í–‰ ìˆœì„œ)</h3>
                <div class="table-container">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th>ìˆœìœ„</th>
                                <th>ìŠ¤í…Œì´ì§€ID</th>
                                <th>ì´íƒˆì(ëª…)</th>
                                <th style="color:#7dd3fc;">ì‹œë„ ìœ ì €</th>
                                <th style="color:#7dd3fc;">í´ë¦¬ì–´ ìœ ì €</th>
                                <th style="color:#7dd3fc;">êµ¬ê°„ í†µê³¼ìœ¨</th>
                                <th>ìŠ¹ë¥  (ì „ì²´)</th>
                                <th>KD ë¹„ìœ¨</th>
                                <th>í‰ê·  ì‹œë„</th>
                                <th>ìƒíƒœ ì§„ë‹¨</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ê¸°ë³¸ ì„¤ì • ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#38bdf8'; dropZone.style.backgroundColor = '#1e293b'; });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = '#334155'; dropZone.style.backgroundColor = ''; });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#334155';
            handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        function handleFile(file) {
            if (!file) return;

            const fileName = file.name.toLowerCase();
            if (fileName.endsWith('.csv')) {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: false, 
                    skipEmptyLines: true,
                    complete: function(results) {
                        analyzeData(results.data);
                    }
                });
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { raw: false });
                    analyzeData(json);
                };
                reader.readAsArrayBuffer(file);
            } else {
                alert("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. .csv ë˜ëŠ” .xlsx íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”.");
            }
        }

        // --- ë¶„ì„ ë¡œì§ ---
        function analyzeData(data) {
            data.sort((a, b) => {
                const dateA = new Date(a.created_at);
                const dateB = new Date(b.created_at);
                if (isNaN(dateA)) return 1;
                if (isNaN(dateB)) return -1;
                return dateA - dateB;
            });

            const players = {}; 
            const stages = {};  

            data.forEach(row => {
                const pid = String(row.player_id || "").trim();
                const sid = row.stage_id;
                const result = parseInt(row.end_case); 
                const playtime = parseInt(row.total_play_time_raw) || 0;
                const kills = parseInt(row.count_unit_destroyed) || 0;
                const lost = parseInt(row.count_unit_lost) || 0;

                if (!pid || !sid || isNaN(result)) return;

                players[pid] = sid; 

                if (!stages[sid]) {
                    stages[sid] = { 
                        id: sid, total: 0, win: 0, lose: 0, leave: 0, restart: 0,
                        winTime: 0, winCount: 0, failTime: 0, failCount: 0,
                        kills: 0, deaths: 0, 
                        uniquePlayers: new Set(), 
                        uniqueWinners: new Set() 
                    };
                }

                stages[sid].total++;
                stages[sid].uniquePlayers.add(pid);
                stages[sid].kills += kills;
                stages[sid].deaths += lost;

                if (result === 0) {
                    stages[sid].win++;
                    stages[sid].winTime += playtime;
                    stages[sid].winCount++;
                    stages[sid].uniqueWinners.add(pid);
                } else if (result === 1) {
                    stages[sid].lose++;
                    stages[sid].failTime += playtime;
                    stages[sid].failCount++;
                } else if (result === 2) {
                    stages[sid].leave++;
                    stages[sid].failTime += playtime; 
                    stages[sid].failCount++;
                } else if (result === 3) {
                    stages[sid].restart++;
                }
            });

            const churnCounts = {};
            Object.values(players).forEach(lastStage => {
                churnCounts[lastStage] = (churnCounts[lastStage] || 0) + 1;
            });

            const stageList = Object.keys(stages).map(sid => {
                const s = stages[sid];
                const churn = churnCounts[sid] || 0;
                const winRate = s.total > 0 ? (s.win / s.total * 100) : 0;
                const kdRatio = s.deaths > 0 ? (s.kills / s.deaths) : s.kills;
                const avgWinTime = s.winCount > 0 ? Math.round(s.winTime / s.winCount) : 0;
                const avgFailTime = s.failCount > 0 ? Math.round(s.failTime / s.failCount) : 0;
                const attemptsPerUser = s.uniquePlayers.size > 0 ? (s.total / s.uniquePlayers.size) : 0;
                const passRate = s.uniquePlayers.size > 0 ? (s.uniqueWinners.size / s.uniquePlayers.size * 100) : 0;

                return {
                    id: sid,
                    churn: churn,
                    total: s.total,
                    winRate: winRate,
                    kdRatio: kdRatio,
                    avgWinTime: avgWinTime,
                    avgFailTime: avgFailTime,
                    attemptsPerUser: attemptsPerUser,
                    uniqueAttempts: s.uniquePlayers.size, 
                    uniqueClears: s.uniqueWinners.size,   
                    passRate: passRate                    
                };
            });

            const topPlayedStages = [...stageList].sort((a, b) => b.total - a.total).slice(0, 20);
            const topChurnStages = [...stageList].sort((a, b) => b.churn - a.churn).slice(0, 20);
            
            // í…Œì´ë¸”ìš©: ì •êµí•œ ìŠ¤í…Œì´ì§€ ì •ë ¬
            const sortedForTable = [...stageList].sort((a, b) => {
                const isTutA = a.id.toLowerCase().includes('tutorial');
                const isTutB = b.id.toLowerCase().includes('tutorial');
                if (isTutA && !isTutB) return -1;
                if (!isTutA && isTutB) return 1;

                const getNum = (str) => {
                    const match = str.match(/(\d+)/g);
                    return match ? parseInt(match[match.length - 1]) : 999; 
                };
                const numA = getNum(a.id);
                const numB = getNum(b.id);
                if (numA !== numB) return numA - numB;
                return a.id.localeCompare(b.id);
            });

            updateDashboard(players, data.length, topChurnStages, topPlayedStages, sortedForTable, stageList);
        }

        function updateDashboard(players, totalSessions, topChurn, topPlayed, tableData, allStages) {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('dropZone').style.display = 'none';

            const totalPlayers = Object.keys(players).length;
            document.getElementById('totalPlayers').innerText = totalPlayers.toLocaleString() + "ëª…";
            document.getElementById('totalSessions').innerText = totalSessions.toLocaleString() + "íŒ";
            
            document.getElementById('topChurnStage').innerText = topChurn[0].id;
            const churnRate = (topChurn[0].churn / totalPlayers * 100).toFixed(1);
            document.getElementById('topChurnRate').innerText = `ì „ì²´ ìœ ì €ì˜ ${churnRate}% ì´íƒˆ`;

            const avgTry = (allStages.reduce((sum, s) => sum + s.attemptsPerUser, 0) / allStages.length).toFixed(1);
            document.getElementById('avgRetry').innerText = `${avgTry}íšŒ`;

            renderPlotlyCharts(topChurn, topPlayed);
            renderTable(tableData, totalPlayers);
        }

        function renderPlotlyCharts(churnData, playedData) {
            const colors = {
                bar: '#38bdf8',
                bar2: '#fbbf24',
                danger: '#f87171',
                success: '#4ade80',
                text: '#cbd5e1',
                grid: '#334155'
            };

            // 1. ì´íƒˆ ì°¨íŠ¸
            const churnTrace = {
                x: churnData.map(d => d.id),
                y: churnData.map(d => d.churn),
                type: 'bar',
                marker: { color: colors.danger, opacity: 0.8 },
                text: churnData.map(d => d.churn + 'ëª…'),
                textposition: 'auto'
            };
            Plotly.newPlot('churnChart', [churnTrace], {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: colors.text },
                margin: { t: 10, b: 60, l: 30, r: 10 },
                xaxis: { gridcolor: colors.grid, tickfont: { size: 10 }, tickangle: -45, automargin: true },
                yaxis: { gridcolor: colors.grid }
            });

            // 2. ë°¸ëŸ°ìŠ¤ ë§µ
            const scatterTrace = {
                x: playedData.map(d => d.winRate),
                y: playedData.map(d => d.kdRatio),
                mode: 'markers+text',
                text: playedData.map(d => d.id),
                textposition: 'top center',
                textfont: { size: 9 },
                marker: {
                    size: playedData.map(d => Math.sqrt(d.churn) * 6 + 6),
                    color: playedData.map(d => d.kdRatio),
                    colorscale: 'Bluered',
                    showscale: false,
                    opacity: 0.8,
                    line: { color: 'white', width: 1 }
                },
                type: 'scatter'
            };
            
            const layoutScatter = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: colors.text },
                xaxis: { title: 'ìŠ¹ë¥  (%)', range: [0, 105], gridcolor: colors.grid },
                yaxis: { title: 'KD ë¹„ìœ¨', gridcolor: colors.grid },
                shapes: [
                    { type: 'line', x0: 50, x1: 50, y0: 0, y1: 5, line: { color: 'rgba(255,255,255,0.3)', width: 1, dash: 'dot'} },
                    { type: 'line', x0: 0, x1: 100, y0: 1, y1: 1, line: { color: 'rgba(255,255,255,0.3)', width: 1, dash: 'dot'} }
                ]
            };
            Plotly.newPlot('scatterChart', [scatterTrace], layoutScatter);

            // 3. í”Œë ˆì´ íƒ€ì„
            const timeTrace1 = {
                x: playedData.map(d => d.id),
                y: playedData.map(d => (d.avgWinTime / 60).toFixed(1)), 
                name: 'ìŠ¹ë¦¬ ì‹œê°„ (ë¶„)',
                type: 'bar',
                marker: { color: colors.success }
            };
            const timeTrace2 = {
                x: playedData.map(d => d.id),
                y: playedData.map(d => (d.avgFailTime / 60).toFixed(1)), 
                name: 'íŒ¨ë°°/ì´íƒˆ ì‹œê°„ (ë¶„)',
                type: 'bar',
                marker: { color: colors.bar2 }
            };
            Plotly.newPlot('timeChart', [timeTrace1, timeTrace2], {
                barmode: 'group',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: colors.text },
                margin: { t: 10, b: 60, l: 30, r: 10 }, 
                legend: { orientation: 'h', y: 1.1 },
                xaxis: { gridcolor: colors.grid, tickfont: { size: 10 }, tickangle: -45, automargin: true },
                yaxis: { gridcolor: colors.grid, title: 'ë¶„ (Minute)' }
            });
        }

        function renderTable(data, totalUsers) {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';

            data.forEach((d, i) => {
                let statusHtml = '';
                if (d.passRate < 30) statusHtml += '<span class="tag tag-danger">í†µê³¡ì˜ë²½</span> '; 
                else if (d.churn / totalUsers > 0.1) statusHtml += '<span class="tag tag-danger">ì´íƒˆì£¼ì˜</span> ';
                
                if (d.kdRatio < 1.0) statusHtml += '<span class="tag tag-warn">ë¶ˆì¾Œí•¨</span> ';
                if (d.avgFailTime < 60 && d.leaves > 2) statusHtml += '<span class="tag tag-warn">ì¦‰ì‹œì´íƒˆ</span>';
                if (statusHtml === '') statusHtml = '<span class="tag tag-good">ì–‘í˜¸</span>';

                const min = Math.floor(d.avgWinTime / 60);
                const sec = d.avgWinTime % 60;
                const timeStr = `${min}ë¶„ ${sec}ì´ˆ`;

                // â˜… ìˆ˜ì •ëœ ë¶€ë¶„: íŠœí† ë¦¬ì–¼ì¼ ê²½ìš° KD ë¹„ìœ¨ì„ '-'ë¡œ í‘œì‹œ
                let kdDisplay = d.kdRatio.toFixed(2);
                if (d.id.toLowerCase().includes('tutorial')) {
                    kdDisplay = '-';
                }

                const row = `
                    <tr>
                        <td>${i + 1}</td>
                        <td style="font-weight:bold; color:#fff;">${d.id}</td>
                        <td style="color:#f87171; font-weight:bold;">${d.churn}ëª…</td>
                        <td style="color:#7dd3fc;">${d.uniqueAttempts}ëª…</td>
                        <td style="color:#7dd3fc;">${d.uniqueClears}ëª…</td>
                        <td style="color:#7dd3fc; font-weight:bold;">${d.passRate.toFixed(1)}%</td>
                        <td>${d.winRate.toFixed(1)}%</td>
                        <td>${kdDisplay}</td>
                        <td>${d.attemptsPerUser.toFixed(1)}íšŒ</td>
                        <td>${statusHtml}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
    </script>
</body>
</html>
